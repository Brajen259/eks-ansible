---
- name: Create the Kubernetes Dashboard
  hosts: local
  connection: local
  gather_facts: no
  tags:
    - k8s
  vars_files:
    - ../cloudformation/output.yaml
    - ./secret.yml
  tasks:
    - name: Apply the Kubernetes Dashboard definition
      k8s:
        state: present
        src: '../eks/kubernetes-dashboard.yaml'
    - name: Apply the Heapster definition
      k8s:
        state: present
        src: '../eks/heapster.yaml'
    - name: Apply the InfluxDB definition
      k8s:
        state: present
        src: '../eks/influxdb.yaml'
    - name: Apply the Heapster RBAC definition
      k8s:
        state: present
        src: '../eks/heapster-rbac.yaml'
    - name: Apply the EKS Admin definition
      k8s:
        state: present
        src: '../eks/eks_admin.yaml'
    - name: Get the kube-system secret for eks-admin
      k8s_facts:
        namespace: kube-system
        kind: secret
      register: secrets
      no_log: True
    - name: Find the eks-admin secret
      set_fact:
        token: '{{ item["data"]["token"] | b64decode }}'
      loop: '{{ secrets["resources"] }}'
      when: >
        item["metadata"] is defined 
          and item["metadata"]["annotations"] is defined
          and item["metadata"]["annotations"]["kubernetes.io/service-account.name"] is defined
          and item["metadata"]["annotations"]["kubernetes.io/service-account.name"] == "eks-admin"
      no_log: True
    - name: Print the Kubernetes Dashboard token
      debug:
        var: token